rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }

    // Users collection - users can only read and write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow delete: if false; // Never allow user deletion via client
    }

    // Courses collection - public read access for pricing display, admins can write
    match /courses/{courseId} {
      allow read: if true; // Allow anyone to read courses for pricing display
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Features collection - public read access for course features display
    match /features/{courseId} {
      allow read: if true; // Allow anyone to read course features for pricing display
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Videos collection - STRICT ACCESS CONTROL
    match /videos/{videoId} {
      // Only allow reading video metadata if user owns the course or is admin
      allow read: if isAdmin() || 
                     (isAuthenticated() && 
                      exists(/databases/$(database)/documents/user_courses/$(request.auth.uid + '_' + resource.data.course_id)));
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // User courses collection - STRICT OWNERSHIP
    match /user_courses/{userCourseId} {
      // Only allow reading your own enrollment records
      allow read: if isAuthenticated() && 
                     (resource.data.user_id == request.auth.uid || isAdmin());
      
      // Only allow listing with proper user_id filter (enforced by document structure)
      allow list: if isAuthenticated() && 
                     request.query.where('user_id', '==', request.auth.uid) != null;
      
      // Allow create only if creating for yourself with valid data
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'course_id', 'last_accessed']) &&
                       request.resource.data.user_id is string &&
                       request.resource.data.course_id is string;
      
      // Allow update only if you own the document
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid; // Prevent user_id changes
      
      allow delete: if false; // Never allow deletion via client
    }
    
    // User progress collection - STRICT OWNERSHIP
    match /user_progress/{progressId} {
      // Only allow reading your own progress
      allow read: if isAuthenticated() && 
                     (resource.data.user_id == request.auth.uid || isAdmin());
      
      // Only allow listing with proper user_id filter
      allow list: if isAuthenticated() && 
                     request.query.where('user_id', '==', request.auth.uid) != null;
      
      // Allow create only if creating for yourself with valid data
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'course_id']) &&
                       request.resource.data.user_id is string &&
                       request.resource.data.course_id is string;
      
      // Allow update only if you own the document
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid; // Prevent user_id changes
      
      allow delete: if false; // Never allow deletion via client
    }
    
    // Payments collection - ULTRA STRICT
    match /payments/{paymentId} {
      // Only allow reading your own payments
      allow read: if isAuthenticated() && 
                     (resource.data.user_id == request.auth.uid || isAdmin());
      
      // Only allow listing with proper user_id filter
      allow list: if isAuthenticated() && 
                     request.query.where('user_id', '==', request.auth.uid) != null;
      
      // Allow create only with strict validation
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'course_id', 'amount', 'status']) &&
                       request.resource.data.user_id is string &&
                       request.resource.data.course_id is string &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.status in ['pending', 'completed', 'failed'];
      
      // Allow update only for status changes and only if you own it
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == resource.data.user_id && // No user_id changes
                       request.resource.data.course_id == resource.data.course_id && // No course_id changes
                       request.resource.data.amount == resource.data.amount; // No amount changes
      
      allow delete: if false; // Never allow payment deletion via client
    }
    
    // Explicit deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}